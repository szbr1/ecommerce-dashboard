generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             Int           @id @default(autoincrement())
  name           String
  email          String @unique
  password       String 
  roles          manyUsers[] 
  profile        UserProfile?
  orders         Order[] 
  address        Address[]
  contact        Contact? 
  access         StoreAccess[]
  store          Store[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  followedStores Follower[]
  reviews        Review[]
  comments      Comment[]

  @@index([email])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

model Role {
  id        Int         @id @default(autoincrement())
  name      UserRole    @unique
  manyUsers manyUsers[]
}

model manyUsers {
  roleId Int
  userId Int

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([roleId, userId])
}

model UserProfile {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  user        User     @relation(fields: [userId], references: [id])
  imageUrl    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  description String
  address   Address[]
  contact   Contact?

}

enum StoreStatus {
  ACTIVE
  DEACTIVATED
  FROZEN
  DELETED
}

model Store {
  id          Int           @id @default(autoincrement())
  profile     StoreProfile?
  status      StoreStatus   @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt()
  products    Product[]
  roles       StoreAccess[]
  user        User          @relation(fields: [userId], references: [id])
  userId      Int
  followers   Follower[]
  orders      OrderItem[]

  @@index([id])
}

model StoreProfile {
  storeId Int @unique
  store Store @relation(fields: [storeId], references: [id])
  name String
  description String
  avatarUrl String?
  banner String?
  brandshoot String?
  brandshootProduct1 String?
  brandshootProduct2 String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Follower {
  id        Int      @id @default(autoincrement())
  storeId   Int
  store     Store    @relation(fields: [storeId], references: [id])
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([storeId])
  @@index([userId])
}

model StoreAccess {
  storeId     Int
  store       Store      @relation(fields: [storeId], references: [id])
  userId      Int
  user        User       @relation(fields: [userId], references: [id])
  permissions StoreRoles @default(ADMIN)

  @@id([storeId, userId])
}

enum StoreRoles {
  ADMIN
  OWNER
  MODERATOR
}

model Product {
  id          Int      @id @default(autoincrement())

  title       String
  sub_title   String?
  description String?
  imagesUrl   String[]
  colors      String[]
  size        String[]

  price       Decimal
  stock       Int
  sold        Int      @default(0)

  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])

  orders      OrderItem[]
  storeId     Int
  store       Store    @relation(fields: [storeId], references: [id])

  reviews     Review[]
  priceHistory ProductPriceHistory[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt()

  @@index([id])
  @@index([title])
}

model ProductPriceHistory {
  id         Int      @id @default(autoincrement())
  productId  Int
  product    Product  @relation(fields: [productId], references: [id])
  price      Decimal
}

model Order {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  trackingId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt()
  orderItems OrderItem[]
  addressId Int 
  address Address @relation(fields: [addressId], references: [id])
  @@index([createdAt, userId])

}

model OrderItem {
  id       Int       @id @default(autoincrement())
  productId Int
  product    Product  @relation(fields: [productId], references: [id])
  storeId Int
  store Store @relation(fields: [storeId], references: [id])
  orderId Int
  order Order @relation(fields: [orderId], references: [id])
  quantity Int
  productAtPrice Decimal
}

model Category {
  id       Int       @id @default(autoincrement())
  products Product[]
  name     String
}

model Address {
  id       Int     @id @default(autoincrement())
  userId   Int
  user     User    @relation(fields: [userId], references: [id])
  profileId Int
  profile UserProfile @relation(fields: [profileId], references: [id])
  zip      String?
  state    String
  province String
  Street2  String?
  Street1  String
  orders   Order[]
  @@index([province])
}

model Contact {
  id       Int    @id @default(autoincrement())
  userId   Int    @unique
  user     User   @relation(fields: [userId], references: [id])
  profileId Int @unique
  profile UserProfile @relation(fields: [profileId], references: [id])
  contact1 Int
  contact2 Int?
  email    String @unique

  @@index([email])
}

model Review {
 id       Int    @id @default(autoincrement())
 productId Int
 userId Int 
 comment String 
 createdAt      DateTime      @default(now())
 updatedAt      DateTime      @updatedAt
 stars Int
 comments Comment[]
 user User @relation(fields: [userId], references: [id])
 product Product @relation(fields: [productId], references: [id])
 @@unique([userId, productId])
}


model Comment {
  id        Int      @id @default(autoincrement())
  message String 
  createdAt      DateTime      @default(now())
  reviewId     Int
  review       Review      @relation(fields: [reviewId], references: [id])
  commenterId Int
  commenter   User      @relation(fields: [commenterId], references: [id])
}


